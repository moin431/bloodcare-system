<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Private Chat</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body{background:#ece5dd;font-family:Arial}
        .chat-container{max-width:420px;margin:auto;background:white;height:90vh;
            display:flex;flex-direction:column;border-radius:10px;overflow:hidden}

        .chat-header{background:#075e54;color:white;padding:12px;font-weight:bold}

        .chat-box{flex:1;overflow-y:auto;padding:10px}

        .msg{margin:6px 0;max-width:70%;padding:8px 12px;border-radius:10px}

        .sent{background:#dcf8c6;margin-left:auto}
        .received{background:#fff}

        .chat-input{display:flex;border-top:1px solid #ddd}
        .chat-input input{flex:1;padding:10px;border:none}
        .chat-input button{background:#075e54;color:white;border:none;padding:10px 16px}
    </style>
</head>

<body>

<div class="chat-container">

    <div class="chat-header">
        <h4 th:text="${otherUser != null ? otherUser.name : 'Unknown User'}"></h4>
    </div>

    <div id="chatBox" class="chat-box">

        <div th:each="m : ${messages}"
             class="msg"
             th:classappend="${m.senderId == currentUserId} ? ' sent' : ' received'"
             th:text="${m.content}">
        </div>


    </div>

    <div class="chat-input">
        <input id="text" placeholder="Type message...">
        <button onclick="send()">Send</button>
    </div>

</div>

<script th:inline="javascript">

    /*<![CDATA[*/

    let roomId = /*[[${roomId}]]*/ "";
    let currentId = /*[[${currentUserId}]]*/ "";
    let receiverId = /*[[${otherUser != null ? otherUser.id : ''}]]*/ "";

    let socket = new SockJS('/chat');
    let stomp = Stomp.over(socket);

    stomp.debug = null;

    stomp.connect({}, function () {

        console.log("CONNECTED");

        stomp.subscribe('/topic/chat/' + roomId, function (res) {

            console.log("RECEIVED", res.body);

            let m = JSON.parse(res.body);
            let box = document.getElementById("chatBox");

            let div = document.createElement("div");

            if (m.senderId === currentId) {
                div.className = "msg sent";
            } else {
                div.className = "msg received";
            }

            div.innerText = m.content;

            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });

    });

    function send() {

        let text = document.getElementById("text").value.trim();

        if (text === "" || receiverId === "") return;

        console.log("SENDING:", text);

        stomp.send("/app/chat/" + roomId, {}, JSON.stringify({
            content: text,
            senderId: currentId,
            receiverId: receiverId,
            emergency: false,
            seen: false
        }));

        document.getElementById("text").value = "";
    }

    /*]]>*/

</script>


</body>
</html>
